Bootstrap: docker
From: nvidia/cuda:12.1.1-base-ubuntu22.04

%post
  set -eux
  apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
        python3.10 python3-pip git wget ca-certificates && \
        rm -rf /var/lib/apt/lists/*

  ln -sf /usr/bin/python3.10 /usr/local/bin/python
  python -m pip install --no-cache-dir -U pip

  python -m pip install --no-cache-dir boltz -U \
        --extra-index-url https://download.pytorch.org/whl/cu121

  mkdir -p /opt/boltz_cache
  # Download Boltz 2 model files
  wget -q -O /opt/boltz_cache/boltz2_conf.ckpt \
       https://huggingface.co/boltz-community/boltz-2/resolve/main/boltz2_conf.ckpt
  wget -q -O /opt/boltz_cache/boltz2_aff.ckpt \
       https://huggingface.co/boltz-community/boltz-2/resolve/main/boltz2_aff.ckpt
  wget -q -O /opt/boltz_cache/mols.tar \
       https://huggingface.co/boltz-community/boltz-2/resolve/main/mols.tar
  # Extract mols.tar to create mols directory
  cd /opt/boltz_cache && tar -xf mols.tar && rm mols.tar
  chmod -R a+r /opt/boltz_cache

%environment
  export BOLTZ_CACHE=/opt/boltz_cache
  export NUMBA_CACHE_DIR=/tmp/numba
  export CC=/usr/bin/gcc
  unset LD_PRELOAD        

%runscript
  echo "Boltz‑2 container – CUDA visible through Singularity"
  exec "$@"
